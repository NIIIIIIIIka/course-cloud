services:
  mysql:
    image: mysql:8  # 注意：mysql:8 最新版可能自动拉取 8.4，若需稳定版可指定 8.0（如 mysql:8.0.38）
    container_name: course-mysql-1
    environment:
      - MYSQL_ROOT_PASSWORD=123456
      - MYSQL_DATABASE=course  # 与应用连接串一致
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      # 可选：若需初始化 root 用户为 mysql_native_password 认证，添加初始化脚本
      - ./init-mysql.sql:/docker-entrypoint-initdb.d/init-mysql.sql
    networks:
      - coursehub-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-p$$MYSQL_ROOT_PASSWORD"]
      interval: 2s
      timeout: 5s
      retries: 20
    # 关键修复：删除废弃的 default-authentication-plugin 参数
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci  # 仅保留字符集配置（可选）

  app:
    image: eclipse-temurin:17-jre-alpine
    container_name: course-app-1
    ports:
      - "8081:81"
    environment:
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/course?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true&connectTimeout=60000
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=123456
      - SPRING_JPA_HIBERNATE_DDL_AUTO=update
      - SPRING_MAIN_WEB_APPLICATION_TYPE=SERVLET
      - SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT=org.hibernate.dialect.MySQL8Dialect  # 适配 MySQL 8+
    volumes:
      # 确保宿主机 jar 包路径正确（替换为你的实际路径）
      - D:/Project/java/microservice/course/Course/target/Course-0.0.1-SNAPSHOT.jar:/app/app.jar
    networks:
      - coursehub-network
    depends_on:
      mysql:
        condition: service_healthy
    working_dir: /app
    command: java -jar app.jar --debug

volumes:
  mysql-data:

networks:
  coursehub-network:

# version: '3.8'  # 必须带冒号：版本声明格式
# services:  # 服务节点（冒号后无内容，换行后子节点缩进2/4空格）
#   app:  # 应用服务名（必须带冒号）
#     build: .  # 构建上下文（冒号+空格+路径，不能写 build .）
#     image: coursehub:latest  # 镜像名（必须带冒号：名称:标签）
#     ports:  # 端口映射（冒号后换行，子项缩进）
#       - "8081:8080"  # 宿主机端口:容器端口（必须加引号，格式不能错）
#     environment:  # 环境变量（冒号后换行）
#       - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/course?useSSL=false&serverTimezone=UTC&allowPublicKeyRetrieval=true  # 修复JDBC连接串（补全 :// 和 ? 分隔符）
#       - SPRING_DATASOURCE_USERNAME=root
#       - SPRING_DATASOURCE_PASSWORD=123456
#       - SPRING_JPA_HIBERNATE_DDL_AUTO=update
#     depends_on:  # 依赖服务（冒号后换行）
#       - mysql
#     networks:  # 网络配置（冒号后换行）
#       - coursehub-network

#   mysql:  # MySQL服务名（必须带冒号）
#     image: mysql:8  # 镜像名（必须带冒号：mysql:8）
#     ports:  # 端口映射（冒号后换行）
#       - "3306:3306"  # 宿主机3306映射容器3306（加引号）
#     environment:  # 环境变量（冒号后换行）
#       - MYSQL_DATABASE=course
#       - MYSQL_ROOT_PASSWORD=123456
#     volumes:  # 数据卷（冒号后换行）
#       - mysql-data:/var/lib/mysql  # 数据卷名:容器内路径（必须带冒号，不能写 mysql-datavarlibmysql）
#       - ./init.sql:/docker-entrypoint-initdb.d/init.sql
#     networks:  # 网络配置（冒号后换行）
#       - coursehub-network
#     healthcheck:  # 健康检查（冒号后换行）
#       test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-p123456"]  # 数组格式（正确）
#       interval: 10s  # 间隔（冒号后空格+值）
#       timeout: 5s    # 超时（冒号后空格+值）
#       retries: 3     # 重试次数（冒号后空格+值）

# networks:  # 网络定义（冒号后换行）
#   coursehub-network:  # 网络名（必须带冒号）
#     driver: bridge  # 驱动类型（冒号后空格+值）

# volumes:  # 数据卷定义（冒号后换行）
#   mysql-data:  # 数据卷名（必须带冒号）